// Generated by CoffeeScript 1.6.3
(function() {
  var Content, List, content, escapeHtml, list,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  escapeHtml = function(unsafe) {
    return unsafe.replace(/&(?!amp;)/g, "&amp;").replace(/<(?!lt;)/g, "&lt;").replace(/>(?!gt;)/g, "&gt;").replace(/"(?!quot;)/g, "&quot;").replace(/'(?!#039;)/g, "&#039;");
  };

  List = (function() {
    var listElm, listForm, nav, resizing, self, where;

    function List() {
      this.resize = __bind(this.resize, this);
      this["delete"] = __bind(this["delete"], this);
      this.bindStatus = __bind(this.bindStatus, this);
      this.init = __bind(this.init, this);
    }

    nav = listForm = listElm = null;

    where = [];

    self = List;

    resizing = 0;

    List.prototype.height = 0;

    List.prototype.page = 1;

    List.prototype.pagesize = 0;

    List.prototype.status = 2;

    List.prototype.tableApp = null;

    List.prototype.init = function() {
      var delBtn, searchForm,
        _this = this;
      listForm = $('#list_form');
      nav = $('#nav');
      delBtn = $('#delete');
      listElm = $('#baoliao_list');
      this.height = document.documentElement.clientHeight - 76;
      this.pagesize = parseInt(this.height / 50);
      if (cmstop.IE > 0) {
        this.pagesize--;
      }
      listElm.css('height', this.height + 'px');
      nav.children('li').bind('click', this.bindStatus);
      delBtn.bind('click', function() {
        return _this["delete"]();
      });
      this.tableApp = listElm.table();
      this.tableApp.load({
        page: 1,
        pagesize: this.pagesize,
        url: '?app=baoliao&controller=baoliao&action=page',
        template: $('#baoliao_list_template').html(),
        where: {
          status: this.status
        },
        pagefield: $('#pagination'),
        row_callback: function(li, json) {
          li.bind('click', function(event) {
            var obj;
            obj = $(event.currentTarget);
            if (obj.hasClass('.cur')) {
              return;
            }
            obj.parent().children('.cur').removeClass('cur');
            obj.addClass('cur');
            return content.get(json.baoliaoid);
          });
          li.find(':checkbox').bind('click', function(event) {
            return event.stopPropagation();
          });
          return li.children('.baoliao-list-delete').bind('click', function(event) {
            var obj;
            event.stopPropagation();
            obj = $(event.currentTarget);
            return _this["delete"]({
              'del[]': parseInt(obj.parent().attr('id').substr(4))
            });
          });
        },
        parsed_callback: function() {
          var first;
          if (first = listElm.children().eq(0)) {
            return first.click();
          }
        }
      });
      $('#select_all').bind('click', function(event) {
        var obj;
        obj = $(event.currentTarget);
        return $.each(listElm.find('input:checkbox'), function(i, k) {
          k.checked = obj.is(':checked');
          return true;
        });
      });
      $(window).resize(function() {
        return _this.resize();
      });
      searchForm = $('#search_form');
      searchForm.bind('submit', function() {
        where = {
          start: $('#search_start').val(),
          end: $('#search_end').val(),
          keyword: $('#search_keyword').val()
        };
        _this.tableApp.reload({
          where: where
        });
        return false;
      });
      return $('#search_submit').bind('click', function() {
        return searchForm.submit();
      });
    };

    List.prototype.bindStatus = function(event) {
      var obj;
      obj = $(event.currentTarget);
      if (obj.hasClass('s_3')) {
        return;
      }
      nav.children('.s_3').removeClass('s_3');
      obj.addClass('s_3');
      this.status = obj.attr('status');
      where.status = this.status;
      return this.tableApp.reload({
        page: 1,
        where: where,
        pagesize: this.pagesize
      });
    };

    List.prototype["delete"] = function(data) {
      var _this = this;
      if (data == null) {
        data = listForm.serialize();
      }
      if (!data) {
        return;
      }
      return ct.confirm('确定要删除这些报料吗?', function() {
        $.post('?app=baoliao&controller=baoliao&action=delete', data, function() {
          return _this.tableApp.reload({
            pagesize: _this.pagesize
          });
        }, 'json');
      });
    };

    List.prototype.resize = function() {
      var _this = this;
      if (resizing > 0) {
        clearTimeout(resizing);
      }
      return resizing = setTimeout(function() {
        _this.height = document.documentElement.clientHeight - 76;
        _this.pagesize = parseInt(_this.height / 50);
        if (cmstop.IE > 0) {
          _this.pagesize--;
        }
        listElm.css('height', _this.height + 'px');
        _this.tableApp.reload({
          page: 1,
          pagesize: _this.pagesize
        });
        return resizing = false;
      }, 100);
    };

    return List;

  })();

  Content = (function() {
    var contentComment, contentDate, contentImage, contentIp, contentPV, contentText, contentTitle, contentVideo, controlBar, editing, mainPanel, repostContext, repostDisplay, repostEdit, repostEditBtn, repostLastTime, repostTextarea;

    function Content() {
      this.resize = __bind(this.resize, this);
      this.editRepost = __bind(this.editRepost, this);
      this.doDelete = __bind(this.doDelete, this);
      this.doRelate = __bind(this.doRelate, this);
      this.doComment = __bind(this.doComment, this);
      this.doEdit = __bind(this.doEdit, this);
      this.doReply = __bind(this.doReply, this);
      this.clean = __bind(this.clean, this);
      this.build = __bind(this.build, this);
      this.get = __bind(this.get, this);
      this.init = __bind(this.init, this);
    }

    contentTitle = contentDate = contentComment = contentPV = contentIp = contentText = mainPanel = repostContext = repostEditBtn = repostEdit = repostDisplay = repostTextarea = contentImage = contentVideo = controlBar = repostLastTime = null;

    editing = false;

    Content.prototype.id = 0;

    Content.prototype.data = null;

    Content.prototype.related = null;

    Content.prototype.init = function() {
      var func, i, _i, _len, _ref,
        _this = this;
      contentTitle = $('#content_title');
      contentDate = $('#content_date');
      contentIp = $('#content_ip');
      contentComment = $('#content_comment');
      contentPV = $('#content_pv');
      contentText = $('#content_text');
      mainPanel = $('#main_panel');
      repostEditBtn = $('#repost_edit_exec');
      repostEdit = $('#repost_edit');
      repostDisplay = $('#repost_display');
      repostTextarea = $('#repost_textarea');
      repostContext = $('#repost_context');
      contentImage = $('#content_image');
      contentVideo = $('#content_video');
      controlBar = $('#control_bar');
      repostLastTime = $('#repost_last_time');
      mainPanel.css('height', document.documentElement.clientHeight - 38 + 'px');
      repostEditBtn.bind('click', function() {
        return _this.doReply();
      });
      $('#repost_submit').bind('click', function() {
        return _this.editRepost(repostTextarea.val());
      });
      repostTextarea.bind('_zoom', function(event, data) {
        var direct, height, zoomHandle;
        zoomHandle = repostTextarea.data('zoomHandle');
        if (zoomHandle) {
          clearInterval(zoomHandle);
        }
        height = parseFloat(repostTextarea.css('height'));
        if (height === data) {
          return;
        }
        repostTextarea.css('min-height', 0);
        direct = data - height > 0 ? 1 : -1;
        zoomHandle = setInterval(function() {
          var h;
          h = parseFloat(repostTextarea.css('height'));
          h += direct;
          repostTextarea.css('height', h + 'px');
          if (Math.abs(h - data) < 1) {
            clearInterval(zoomHandle);
            return repostTextarea.css({
              'height': data + 'px',
              'min-height': data + 'px'
            });
          }
        }, 5);
        return repostTextarea.data('zoomHandle', zoomHandle);
      });
      repostTextarea.bind('show', function() {
        var event, html, _blur, _focus, _i, _len, _ref,
          _this = this;
        if (cmstop.IE) {
          repostTextarea.unbind().removeClass('ready').css('height', '120px');
          return;
        }
        html = repostTextarea.val();
        if (html.length < 1) {
          repostTextarea.val('回复内容');
          repostTextarea.addClass('ready');
          _focus = function() {
            repostTextarea.val('');
            repostTextarea.removeClass('ready');
            return repostTextarea.trigger('autoSize');
          };
          _blur = function() {
            var _this = this;
            if (repostTextarea.val().length > 0) {
              return;
            }
            repostTextarea.val('回复内容');
            repostTextarea.addClass('ready');
            repostTextarea.css({
              'height': '30px',
              'min-height': '30px'
            });
            return repostTextarea.one('focus', function() {
              return _focus();
            });
          };
          repostTextarea.one('focus', function() {
            return _focus();
          });
          repostTextarea.bind('blur', function() {
            return _blur();
          });
        }
        repostTextarea.bind('autoSize', function(event) {
          var _height, _textarea;
          event.stopPropagation();
          html = repostTextarea.val() || '';
          _textarea = $('#autosize_text');
          if (_textarea.length === 0) {
            _textarea = $('<textarea id="autosize_text"></textarea>');
            _textarea.css({
              'width': repostTextarea.css('width'),
              'height': '72px!important',
              'min-height': '72px!important',
              'position': 'fixed',
              'top': '99999px',
              'left': '99999px',
              'overflow-y': 'auto',
              'word-wrap': 'break-word',
              'line-height': repostTextarea.css('line-height')
            });
            $('body').append(_textarea);
          }
          _textarea.val(repostTextarea.val());
          _height = _textarea[0].scrollHeight;
          return repostTextarea.trigger('_zoom', _height);
        });
        _ref = ['click', 'changed', 'keydown', 'keyup'];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          event = _ref[_i];
          repostTextarea.bind(event, function() {
            return repostTextarea.trigger('autoSize');
          });
        }
        if (repostTextarea.onpropertychange) {
          return input.onpropertychange = function() {
            return repostTextarea.trigger('autoSize');
          };
        } else {
          return repostTextarea.bind('input', function() {
            return repostTextarea.trigger('autoSize');
          });
        }
      });
      _ref = ['Reply', 'Edit', 'Comment', 'Relate', 'Delete'];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        i = _ref[_i];
        func = function(i) {
          return $('#baoliao_btn_' + i).bind('click', function() {
            return _this['do' + i]();
          });
        };
        func(i);
      }
      return $(window).resize(function() {
        return _this.resize();
      });
    };

    Content.prototype.get = function(id) {
      var _this = this;
      if (id === this.id) {
        return;
      }
      if (this.id > 0) {
        this.clean();
      }
      return $.get('?app=baoliao&controller=baoliao&action=get', {
        id: id
      }, function(response) {
        if (!response.state) {
          ct.error('报料不存在');
          return;
        }
        _this.build(response.data);
        mainPanel.show();
        return _this.id = id;
      }, 'json');
    };

    Content.prototype.build = function(data) {
      var html, i, language, related, source, template, _i, _len, _ref,
        _this = this;
      this.data = data;
      contentTitle.html(data.title);
      contentDate.html(data.date);
      contentIp.html(data.ipstring);
      contentComment.html('评论: ' + data.comments);
      contentPV.html('点击: ' + data.pv);
      contentText.html(data.content);
      source = $('#source');
      language = {
        name: '姓名',
        email: '邮箱',
        phone: '手机',
        qq: 'QQ',
        address: '地址'
      };
      _ref = ['name', 'email', 'phone', 'qq', 'address'];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        i = _ref[_i];
        if (data[i]) {
          source = $("<div class='baoliao-source-item'>" + language[i] + "：" + data[i] + "</div>").insertAfter(source);
        }
      }
      if (data.reply === '1') {
        repostEdit.hide();
        repostDisplay.show();
        repostEditBtn.show();
        repostContext.html(data.replytext);
        repostLastTime.html("" + data.replydate + " 最新回复&nbsp;");
      } else {
        repostEdit.show();
        repostTextarea.trigger('show');
        repostDisplay.hide();
        repostEditBtn.hide();
      }
      related = eval("(" + data.related + ")");
      this.related = related;
      data.image = eval(data.image);
      if (data.image && data.image.length > 0) {
        template = $('#baoliao_image_template').html();
        $.each(data.image, function(i, src) {
          var html;
          html = $(template.replace(/\[src\]/g, UPLOAD_URL + src));
          contentImage.append(html);
          return html.find('.delete').bind('click', function(event) {
            var index, obj;
            obj = $(event.currentTarget).parents('.baoliao-image-item');
            index = obj.index(contentImage.children());
            return ct.confirm('删除该图片?', function() {
              return $.post("?app=baoliao&controller=baoliao&action=image_delete&id=" + _this.id, {
                pic: index
              }, function(response) {
                if (!response.state) {
                  ct.error(response.error || '删除失败');
                  return false;
                }
                return obj.remove();
              }, 'json');
            });
          });
        });
        contentImage.show();
      }
      if (data.video) {
        data.video = eval("(" + data.video + ")");
      }
      if (data.video && data.video.vid) {
        if (data.video.type === 'ctvideo') {
          contentVideo.append('<iframe src="?app=video&controller=vms&action=preview&id=' + data.video.vid + '" frameborder="0" width="600" height="480"></iframe>');
        } else {
          template = $('#baoliao_video_template').html();
          html = $(template.replace(/\[swf\]/g, data.video.swf));
          contentVideo.append(html);
          html.find('.delete').bind('click', function(event) {
            var obj;
            obj = $(event.currentTarget).parent();
            return ct.confirm('删除视频?', function() {
              return $.post("?app=baoliao&controller=baoliao&action=video_delete&id=" + _this.id, null, function(response) {
                if (!response.state) {
                  ct.error(response.error || '删除失败');
                  return false;
                }
                return contentVideo.empty();
              }, 'json');
            });
          });
        }
        contentVideo.show();
      }
      return true;
    };

    Content.prototype.clean = function() {
      var elm, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref2;
      $('.clear_edit').click();
      _ref = [$('.baoliao-source-item'), contentTitle, contentDate, contentComment, contentPV, contentIp, contentText, contentImage, contentVideo];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        elm = _ref[_i];
        elm.empty();
      }
      _ref1 = [repostTextarea];
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        elm = _ref1[_j];
        elm.val('');
      }
      _ref2 = [mainPanel];
      for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
        elm = _ref2[_k];
        elm.hide();
      }
      contentImage.children('.baoliao-image-item').remove();
      this.id = 0;
      return this.related = null;
    };

    Content.prototype.doReply = function() {
      location.hash = 'reply';
      if (!repostEditBtn.is(':visible') && !repostTextarea.hasClass('ready')) {
        return;
      }
      repostTextarea.val(repostContext.html());
      repostEdit.show();
      repostTextarea.focus().trigger('show');
      repostDisplay.hide();
      return repostEditBtn.hide();
    };

    Content.prototype.doEdit = function() {
      var btnDiv, context, contextInput, editor, title, titleInput, _clean,
        _this = this;
      editor = null;
      if (editing) {
        return;
      }
      editing = true;
      titleInput = contextInput = null;
      mainPanel.find('.delete').show();
      controlBar.children('input').hide();
      _clean = function() {
        titleInput.remove();
        contextInput.remove();
        btnDiv.remove();
        contentTitle.show();
        contentText.show();
        editing = false;
        mainPanel.find('.delete').hide();
        $('.miniEditor').remove();
        return controlBar.children('input').show();
      };
      title = escapeHtml(contentTitle.text());
      context = contentText.html();
      titleInput = $('<input type="text" id="content_title_input" value="' + title + '" class="baoliao-content-title" />').insertAfter(contentTitle.hide());
      contextInput = $('<textarea id="content" class="baoliao-content">' + context + '</textarea>').insertAfter(contentText.hide());
      btnDiv = $('<div class="baoliao-edit-btn"></div>').appendTo(controlBar);
      $('<button class="btn clear_edit">取消</button>').prependTo(btnDiv).one('click', function() {
        return _clean();
      });
      $('<button class="btn">保存</button>').prependTo(btnDiv).one('click', function() {
        return $.post("?app=baoliao&controller=baoliao&action=edit&id=" + _this.id, {
          title: titleInput.val(),
          content: editor.getCode()
        }, function(response) {
          if (!response.state) {
            ct.error(response.error || '保存失败');
            return;
          }
          contentTitle.text(titleInput.val());
          contentText.html(editor.getCode());
          return _clean();
        }, 'json');
      });
      editor = new $.Rte(contextInput, {
        disable: ['italic', 'fontsize', 'fontname', 'forecolor', 'insertunorderedlist', 'insertorderedlist', 'justify', 'createlink', 'insertimage', 'html']
      });
      contextInput.val($.trim(editor.getCode()));
      return true;
    };

    Content.prototype.doComment = function() {
      if (!this.data.topicid) {
        ct.error('此报料暂无任何评论');
        return;
      }
      return ct.assoc.open('?app=comment&controller=comment&action=index&rwkeyword=' + this.data.topicid, 'newtab');
    };

    Content.prototype.doRelate = function() {
      var clear, inEditing, offset, popup, _chose,
        _this = this;
      _chose = function(ok, close) {
        var iframe;
        iframe = ct.iframe({
          title: '选择相关内容',
          maxHeight: document.documentElement.clientHeight,
          url: '?app=system&controller=port&action=picker'
        }, {
          ok: function(r) {
            _this.related = {
              id: r[0].contentid,
              title: r[0].title,
              url: r[0].url
            };
            return $.post("?app=baoliao&controller=baoliao&action=post_related&id=" + _this.id, _this.related, function(response) {
              if (response.state) {
                iframe.dialog('close');
                if (typeof ok === 'function') {
                  return ok.call(this);
                }
              } else {
                return ct.error(response.error || '异常错误');
              }
            }, 'json');
          }
        }, null, function() {
          if (typeof close === 'function') {
            return close.call(_this);
          }
        });
        return true;
      };
      if (this.related !== null) {
        clear = 0;
        inEditing = false;
        popup = $('#popup');
        offset = $('#baoliao_btn_Relate').position();
        popup.css({
          left: offset.left + 'px',
          top: offset.top + 22 + 'px'
        });
        popup.find('#popup_title').attr('title', this.related.title).html(this.related.title);
        popup.show();
        popup.children('.view').attr('href', this.related.url);
        popup.children('.edit').unbind().bind('click', function() {
          inEditing = true;
          return _chose(function() {
            popup.find('#popup_title').attr('title', _this.related.title).html(_this.related.title);
            popup.children('.view').attr('href', _this.related.url);
            $('#inpop').focus();
            return inEditing = false;
          }, function() {
            $('#inpop').focus();
            return inEditing = false;
          });
        });
        popup.children('.delete').unbind().bind('click', function() {
          return $.post("?app=baoliao&controller=baoliao&action=delete_related", {
            id: _this.id
          }, function(response) {
            if (response.state) {
              _this.related = null;
              return popup.hide();
            } else {
              return ct.error(response.error || '删除失败');
            }
          }, 'json');
        });
        popup.children('.popup-close').unbind().bind('click', function() {
          return popup.hide();
        });
        popup.unbind().bind('click', function(event) {
          $('#inpop').focus();
          $('#inpop').data('isFocused', true);
          return false;
        });
        return $('#inpop').unbind().focus().bind('blur', function(event) {
          if (inEditing) {
            return;
          }
          $('#inpop').data('isFocused', false);
          clear = setTimeout(function() {
            if (!$('#inpop').data('isFocused')) {
              return popup.hide();
            }
          }, 200);
          return true;
        });
      } else {
        return _chose();
      }
    };

    Content.prototype.doDelete = function() {
      var _this = this;
      ct.confirm('确定要删除该报料吗?', function() {
        return $.post('?app=baoliao&controller=baoliao&action=delete', "del[]=" + _this.id, function() {
          list.tableApp.reload();
          return _this.clean();
        }, 'json');
      });
      return true;
    };

    Content.prototype.editRepost = function(text) {
      return $.post('?app=baoliao&controller=baoliao&action=post_repost', {
        id: this.id,
        text: text
      }, function(response) {
        var date;
        if (!response.state) {
          ct.error(response.error || '提交失败');
          return;
        }
        repostContext.html(repostTextarea.val());
        repostEdit.hide();
        repostDisplay.show();
        repostEditBtn.show();
        date = new Date();
        return repostLastTime.html("" + (date.getFullYear()) + "-" + (date.getMonth() + 1) + "-" + (date.getDate()) + " 最新回复&nbsp;");
      }, 'json');
    };

    Content.prototype.resize = function() {
      return mainPanel.css('height', document.documentElement.clientHeight - 38 + 'px');
    };

    return Content;

  })();

  list = new List;

  content = new Content;

  $(function() {
    list.init();
    content.init();
    return $('.datepicker').DatePicker({
      format: 'yyyy-MM-dd HH:mm'
    });
  });

}).call(this);
